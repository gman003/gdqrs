<html>
<meta charset="utf-8" />
<title>Games Done Quick: Reviewed Slow</title>
<style>
* {
	box-sizing: border-box;
}
.agdq {
	--color-fg-main: #2d6665;
	--color-fg-h1:   #FFF;
	--color-fg-h2:   #FFF;
	--color-bg-main: #000;
	--color-bg-h1:   #339999;
	--color-bg-h2:   #003232;
}
.sgdq {
	--color-fg-main: #2d6665;
	--color-fg-h1:   #FFF;
	--color-fg-h2:   #FFF;
	--color-bg-main: #000;
	--color-bg-h1:   #e10189;
	--color-bg-h2:   #34002c;
}
body {
	box-sizing: border-box;
	background: var(--color-bg-main);
	color: var(--color-fg-main);
}
#runs {
	position: absolute;
	top: 0;
	left: 0;
	width: calc(100% - var(--player-width));
	height: 100%;
	overflow-y: scroll;
	scrollbar-width: thin;
}
#runs h1, #runs h2 {
	width: 100%;
	padding: 4px 24px;
	font-size: 24px;
	font-weight: bold;
	text-align: center;
	margin: 0 0 24px 0;
}
#runs h1 {
	background: var(--color-bg-h1);
	color: var(--color-fg-h1);
}
#runs h1 span {
	display: block;
	font-size: 12px;
}
#runs h2 {
	background: var(--color-bg-h2);
	color: var(--color-fg-h2);
}
#runs::-webkit-scrollbar {
	width: 8px;
}
#runs::-webkit-scrollbar-thumb {
	background: #424242;
}

#main {
	position: absolute;
	top: 0;
	left: calc(100% - var(--player-width));
	width: var(--player-width);
	height: var(--player-height);
	background: black;
	color: white;
	text-align: center;
}
#main div {
	width: 100%;
}
#main #player {
	width: 100%;
	height: 100%;
}
#main .container {
	height: calc(var(--player-height) - 128px);
}
#main .container::-webkit-scrollbar {
	width: 8px;
}
#main .container::-webkit-scrollbar-thumb {
	background: #424242;
}

#navbar {
	position: absolute;
	bottom: 0;
	left: calc(100% - var(--player-width));
	width: var(--player-width);
	height: calc(100% - var(--player-height));
	vertical-align: bottom;
	overflow: hidden;
	background: black;
}
#navbar #days {
	width: 100%;
	bottom: 0;
	position: absolute;
	padding: 0 24px;
	display: flex;
	column-gap: 24px;
}
#navbar #days a {
	flex: 1;
	border-width: 4px 4px 0 4px;
	border-color: var(--color-bg-h2);
	border-style: solid;
	color: var(--color-fg-h2);
	padding: 4px 24px;
	font-weight: bold;
	text-decoration: none;
	text-align: center;
}
#navbar #days a:hover {
	background: var(--color-bg-h2);
}
#navbar #content {
	width: 100%;
	top: 0;
	position: absolute;
	padding: 0 24px;
	display: flex;
	column-gap: 24px;
}
#navbar #content a {
	flex: 1;
	border-width: 0 4px 4px 4px;
	border-color: var(--color-bg-h2);
	border-style: solid;
	color: var(--color-fg-h2);
	padding: 4px 24px;
	font-weight: bold;
	text-decoration: none;
	text-align: center;
}
#navbar #content a:hover {
	background: var(--color-bg-h2);
}

#raw {
	display: none;
}
</style>
<style media="all and (orientation: landscape)">
@media (min-width: 2400px) {
	body {
		--player-width: 1920px;
		--player-height: 1080px;
	}
	#main #browser {
		--eventlist-size: 48px;
	}
	#main #info .container {
		columns: 3 auto;
	}
	#navbar a {
		font-size: 24px;
	}
}
@media (min-width: 1600px) and (max-width: 2400px) {
	body {
		--player-width: 1280px;
		--player-height: 720px;
	}
	#main #browser {
		--eventlist-size: 48px;
	}
	#main #info .container {
		columns: 2 auto;
	}
	#navbar  a {
		font-size: 16px;
	}
}
@media (min-width: 1200px) and (max-width: 1600px) {
	body {
		--player-width: 854px;
		--player-height: 480px;
	}
	#main #browser {
		--eventlist-size: 36px;
	}
	#main #info .container {
		overflow-y: scroll;
	}
	#main #filters .container {
		overflow-y: scroll;
	}
	#main #info .container div {
		height: auto;
	}
	#navbar #days {
		column-gap: 72px;
	}
	#navbar a {
		font-size: 16px;
		padding: 4px;
	}
	#navbar #days a {
		writing-mode: vertical-rl;
		text-orientation: upright;
		padding: 12px;
		vertical-align: top;
	}
}
@media (max-width: 1200px) {
	body {
		--player-width: 640px;
		--player-height: 360px;
	}
	#main #browser {
		--eventlist-size: 36px;
	}
	#main #info .container {
		overflow-y: scroll;
	}
	#main #info .container div {
		height: auto;
	}
	#navbar #content {
		column-gap: 2px;
	}
	#navbar #days {
		column-gap: 18px;
	}
	#navbar a {
		font-size: 12px;
		padding: 2px;
	}
	#navbar #days a {
		writing-mode: vertical-rl;
		text-orientation: upright;
	}
}
</style>
<style media="all and (orientation: portrait)">
#main {
	left: calc((100% - var(--player-width)) / 2);
}
#runs {
	position: absolute;
	top: calc(var(--player-height) + 72px);
	width: 100%;
	height: calc(100% - var(--player-height) - 72px);
}
#navbar {
	width: 100%;
	height: 72px;
	top: var(--player-height);
	left: 0;
}
#navbar div {
	height: 50%;
}
#navbar #days a {
	border-width: 0 4px 4px 4px;
}

@media (min-width: 2560px){
	body {
		--player-width: 2560px;
		--player-height: 1440px;
	}
	#main #browser {
		--eventlist-size: 48px;
	}
	#main #info .container {
		columns: 2 auto;
	}
	#navbar a {
		font-size: 24px;
		padding: 8px;
	}
}
@media (min-width: 1920px) and (max-width: 2560px){
	body {
		--player-width: 1920px;
		--player-height: 1080px;
	}
	#main #browser {
		--eventlist-size: 48px;
	}
	#main #info .container {
		columns: 2 auto;
	}
	#navbar a {
		font-size: 24px;
		padding: 8px;
	}
}
@media (min-width: 1280px) and (max-width: 1920px){
	body {
		--player-width: 1280px;
		--player-height: 720px;
	}
	#main #browser {
		--eventlist-size: 48px;
	}
	#main #info .container {
		columns: 2 auto;
	}
	#navbar a {
		font-size: 24px;
		padding: 8px;
	}
}
@media (min-width: 854px) and (max-width: 1280px){
	body {
		--player-width: 854px;
		--player-height: 480px;
	}
	#main #browser {
		--eventlist-size: 36px;
	}
	#main #info .container {
		overflow-y: scroll;
	}
	#main #info .container div {
		height: auto;
	}
	#navbar a {
		font-size: 16px;
		padding: 4px;
	}
}
@media (max-width: 854px) {
	body {
		--player-width: 640px;
		--player-height: 360px;
	}
	#main #browser {
		--eventlist-size: 24px;
	}
	#main #info .container {
		overflow-y: scroll;
	}
	#main #info .container div {
		height: auto;
	}
	#navbar a {
		font-size: 12px;
		padding: 4px;
	}
}
</style>
<body class="sgdq">
<template id="gdq-run">
	<style>
		* {
			box-sizing: border-box;
		}

		:host(.agdq) {
			--color-fg-head: #ffb900;
			--color-fg-fade: #65662f;
			--color-fg-cont: #e10189;
			--color-bg-head: #424242;
			--color-bg-cont: #2c2c2c;
		}
		:host(.sgdq) {
			--color-fg-head: #ffb900;
			--color-fg-fade: #65662f;
			--color-fg-cont: #5dc2c0;
			--color-bg-head: #424242;
			--color-bg-cont: #2c2c2c;
		}
		
		:host([rating="5"]) .run {
			border: 1px solid var(--color-fg-fade);
		}
		
		.run {
			width: 100%;
			color: var(--color-fg-cont);
			background: var(--color-bg-cont);
			margin-bottom: 16px;
			padding-bottom: 16px;
		}
		.run-title {
			width: 100%;
			color: var(--color-fg-head);
			background: var(--color-bg-head);
			padding: 4px 16px;
			display: flex;
			vertical-align: bottom;
		}
		.title-main {
			font-size: 24px;
			font-weight: bold;
			min-height: 28px;
			line-height: 28px;
			display: inline-block;
			margin-left: 0px;
			flex: auto;
			vertical-align: bottom;
		}
		.title-details {
			font-size: 18px;
			min-height: 28px;
			line-height: 28px;
			color: var(--color-fg-fade);
			display: inline-block;
			margin-right: 0px;
			flex: auto;
			text-align: right;
			vertical-align: bottom;
		}
		.run-item {
			font-size: 18px;
			line-height: 24px;
			margin: 0 16px;
		}
		.score-header {
			display: inline-block;
			width: 20%;
		}
		.score-stars {
			display: inline-block;
			width: 80%;
			color: var(--color-fg-head);
		}
	</style>
	<div class="run">
		<div class="run-title">
			<span class="title-main"><slot name="game">GAME</slot></span>
			<span class="title-details">(<slot name="plat">PLATFORM</slot> - <slot name="dev">DEVELOPER</slot> <slot name="year">YEAR</slot>)</span>
		</div>
		<div class="run-item"><slot name="category">CATEGORY</slot></div>
		<div class="run-item"><slot name="runner">by RUNNER</slot></div>
		<div class="run-item"><slot name="crew">host HOST, couch PEOPLE</slot></div>
		<div class="run-item"><slot name="time">MMmSSs</slot> (<slot name="estimate">est MMm</slot>, <slot name="wr">wr MMmSSs</slot>) <slot name="time-tags">[TAGS]</slot></div>
		<div class="run-item"><div class="score-header">Overall</div><div class="score-stars"><slot name="overall">☆☆☆☆☆</slot></div></div>
		<div class="run-item"><div class="score-header">Skill</div><div class="score-stars"><slot name="skill">☆☆☆☆☆</slot></div></div>
		<div class="run-item"><div class="score-header">Fun</div><div class="score-stars"><slot name="fun">☆☆☆☆☆</slot></div></div>
		<div class="run-item">Review: <slot name="review">(Not Yet Reviewed)</slot></div>
	</div>
</template>

<div id="runs"></div>

<div id="main">
	<div id="browser" hidden="true">
		<h1>Select Marathon</h1>
		<div class="container">
			<a class="agdq" onclick="loadMarathon('agdq2019')">AGDQ 2019<span>(99% - 139/140)</span></a>
			<a class="sgdq" onclick="loadMarathon('sgdq2019')">SGDQ 2019<span>(98% - 145/148)</span></a>
			<a class="agdq" onclick="loadMarathon('agdq2020')">AGDQ 2020<span>(99% - 145/146)</span></a>
			<a class="sgdq" onclick="loadMarathon('sgdq2020')">SGDQ 2020<span>(59% - 87/147)</span></a>
			<a class="agdq" onclick="loadMarathon('agdq2021')">AGDQ 2021<span>(89% - 136/153)</span></a>
			<a class="sgdq" onclick="loadMarathon('sgdq2021')">SGDQ 2021<span>(100% - 150/150)</span></a>
			<a class="agdq" onclick="loadMarathon('agdq2022')">AGDQ 2022<span>(67% - 99/148)</span></a>
		</div>
		<script>
			function loadMarathon(marathon, reset = true){
				var title = marathon.substring(0, 4).toUpperCase() + ' ' + marathon.substring(4);
				
				// set global style
				if (marathon.startsWith('a')){
					document.body.className = "agdq";
				} else {
					document.body.className = "sgdq";
				}
				
				if (reset){
					// scroll back to top and clear day link, unless this is an initial page load
					window.location.hash = "";
					document.getElementById("runs").scrollTo(0,0);
				}
				
				hideAllContentBut('player');
				
				loadReviewsForMarathon(marathon);
				
				// set URL
				
				if (reset && window.location.protocol != "file:"){
					var url = new URL(window.location.origin + window.location.pathname); // clear that obnoxious #
				} else {
					var url = new URL(window.location);
				}
				url.searchParams.set('m', marathon);
				window.history.pushState({"html":document.body.innerHTML},title, url);
			}
		</script>
		<style>
			#main #browser h1 {
				font-size: var(--eventlist-size);
				font-weight: bold;
				font-family: sans-serif;
				margin: 0;
				padding: calc(var(--eventlist-size)/2) 0 var(--eventlist-size) 0;
			}
			#main #browser .container {
				--eventlist-button-width: calc(var(--eventlist-size) * 20 / 3) /*320px*/;
				--eventlist-button-height: calc(var(--eventlist-size) * 5 / 2) /*120px*/;
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(var(--eventlist-button-width), 1fr));
				padding: var(--eventlist-size);
			}
			#main #browser a {
				font-size: var(--eventlist-size);
				font-weight: bold;
				font-family: sans-serif;
				text-align: center;
				width: var(--eventlist-button-width);
				height: var(--eventlist-button-height);
				padding: calc(var(--eventlist-size)/2);
				margin: auto;
				border: 2px solid var(--color-bg-h1);
				background: var(--color-bg-h2);
			}
			#main #browser a span {
				display: block;
				font-size: 12px;
			}
		</style>
	</div>
	<div id="player" hidden="true">Youtube Player - If you see this, either you've disabled Javascript, or Youtube's messed up.</div>
	<div id="filters" hidden="true">
		<h1>Filters</h1>
		<div class="container">
			<div>
				<h3>By Ratings</h3>
				<label><input type="checkbox" name="rating"         rating="N"/>Not Rated</label>
				<label><input type="checkbox" name="rating" checked rating="0"/>☆☆☆☆☆</label>
				<label><input type="checkbox" name="rating" checked rating="1"/>★☆☆☆☆</label>
				<label><input type="checkbox" name="rating" checked rating="2"/>★★☆☆☆</label>
				<label><input type="checkbox" name="rating" checked rating="3"/>★★★☆☆</label>
				<label><input type="checkbox" name="rating" checked rating="4"/>★★★★☆</label>
				<label><input type="checkbox" name="rating" checked rating="5"/>★★★★★</label>
				<label><input type="checkbox" name="rating" checked rating="S"/>Special</label>
			</div>
			<div>
				<h3>By People</h3>
				<label><input type="text" name="runner" placeholder="(eg. TheMexicanRunner)" />Runner(s)</label>
				<label><input type="text" name="crew" placeholder="(eg. SpikeVegeta)" />Crew</label>
				<p>Tip: Search "[WRH]" to find only runs by world record holders, or "race" to find competitive races.</p>
			</div>
			<div>
				<h3>By Game</h3>
				<label><input type="text" name="game" placeholder="(eg. Mario)" />Game Title</label>
				<label><input type="text" name="category" placeholder="(eg. Any%)" />Run Category</label>
				<label><input type="text" name="platform" placeholder="(eg. NES)" />Platform</label>
			</div>
		</div>
		
		<style>
		#filters .container {
			columns: 2 auto;
			gap: 8px;
		}
		#filters .container div {
			display: inline-block;
		}
		#filters h3 {
			width: 100%;
			background: var(--color-fg-main);
			color: black;
		}
		#filters label {
			display: block;
			text-align: left;
		}
		#filters input {
			margin: 8px 8px 8px 24px;
		}
		</style>
	</div>
	<div id="info" hidden="true">
		<h1>Information</h1>
		<div class="container">
			<div>
				<h3>Timing</h3>
				<p>Run times given are RTA/with loads. When possible, WR is given as RTA/with loads, even when rankings are determined IGT/loadless - so the IGT-based record holder is maintained, but I list the WR's RTA timing, for easiest comparison to the run length. Exceptions to this standard (eg. where the leaderboards do not list RTA timings) are noted.</p>
				<p>Run times generally follow the on-screen timer, except when that is significantly mistimed. Exhibition and showcase runs generally give a rough time, as they have no record to compare to.</p>
				<p>Leaderboards are generally checked a few days before the event begins, so last-minute record snags may be missed.</p>
			</div>
			<div>
				<h3>Ratings Guide</h3>
				<p>I am in the habit of using the full range of ratings, which may seem harsh to those used to seeing nothing lower than a 7/10. For reference, I expect to give only a few five-star ratings in each event, and even a single-star run is worth watching if it's a game or runner you particularly enjoy.</p>
				<table>
				<tr><th>☆☆☆☆☆</th><td>Don't bother watching</td></tr>
				<tr><th>★☆☆☆☆</th><td>A weak run, can still be fun if it's a game you love but otherwise skippable</td></tr>
				<tr><th>★★☆☆☆</th><td>A solid but unremarkable run</td></tr>
				<tr><th>★★★☆☆</th><td>A good run, not a highlight but worth watching eventually</td></tr>
				<tr><th>★★★★☆</th><td>A great run, only avoid if it's a game or runner you just can't stand</td></tr>
				<tr><th>★★★★★</th><td>One of the best runs of all time</td></tr>
				</table>
			</div>
			<div>
				<h3>Corrections &amp; Contributions</h3>
				<p>If any information is factually incorrect (eg. wrong developer name, misspelled couch member), please feel free to <a href="https://github.com/gman003/gdqrs/issues">file a bug on the GitHub page</a>.</p>
				<p>If you wish to contribute to this project, <a href="https://github.com/gman003/gdqrs">check out the GitHub</a>. While I do not accept outside reviews, I'm more than happy to include fixes or improvements.</p>
			</div>
			<div>
				<h3>Legal Blurb</h3>
				<p>Games Done Quick: Reviewed Slow is by GMan003. The above reviews are my personal and subjective opinion.</p>
				<p>Games Done Quick and Awesome Games Done Quick are registered trademarks of Games Done Quick LLC, used here under nominative fair use. GDQ is an awesome event for good causes, and you should be watching it and giving them money.</p>
			</div>
		</div>
		<style>
			#main #info .container {
				gap: 8px;
			}
			#main #info .container div {
				display: inline-block;
			}
			#main #info h3 {
				width: 100%;
				background: var(--color-fg-main);
				color: black;
			}
			#main #info p {
				text-align: left;
			}

			#main #info table {
				width: 100%;
			}
			#main #info table th {
				color: #ffb900;
				padding: 2px;
			}
			#main #info table tr td {
				color: var(--color-fg-h1);
			}
		</style>
	</div>
</div>

<div id="navbar">
	<div id="days"></div>
	<div id="content">
		<a onclick="hideAllContentBut('player')">Video</a>
		<a onclick="hideAllContentBut('filters')">Filters</a>
		<a onclick="hideAllContentBut('info')">About / Ratings Guide</a>
		<a onclick="hideAllContentBut('browser')">Event Browser</a>
	</div>
	<script>
		function hideAllContentBut(exception){
			console.log(`hiding all but ${exception}`);
			for (var element of ['browser', 'player', 'filters', 'info']){
				document.getElementById(element).hidden = element != exception;
			}
		}
	</script>
</div>

<script>
function createSlot(slot, content){
	var ret = document.createElement("span");
	ret.setAttribute("slot", slot);
	ret.innerHTML = content;
	return ret;
}
function defineTags(input){
	const tags = {
		// run tags
		'[WR]':		'New World Record!!!',
		'[PB]':		'New Personal Best!',
		'[NF]':		'Did Not Finish',
		'[NV]':		'Run Not Valid',
		'[WR?]':	'Possible World Record?',
		
		// runner tags
		'[WRH]':	'World Record Holder',
		'[2RH]':	'2nd Place Record Holder',
		'[3RH]':	'3rd Place Record Holder',
		'[ORH]':	'Only Record Holder',
		
		// couch tags
		'[VA]':		'Voice Actor',
		'[DEV]':	'Game Developer',
		'[CM]':		'Community Manager',
	};
	for (var tag in tags){
		input = input.replaceAll(tag, '<abbr title="' + tags[tag] + '">' + tag + '</abbr>');
	}
	return input;
}
function definePlatforms(input){
	return input.split(/\s+/).map(function(w){
		const platforms = {
			'NES':		'Nintendo Entertainment System',
			'SNES': 	'Super Nintendo Entertainment System',
			'N64':		'Nintendo 64',
			'GC':		'Nintendo GameCube',
			'GB':		'Nintendo Game Boy',
			'GBC':		'Nintendo Game Boy Color',
			'GBA':		'Nintendo Game Boy Advance',
			'DS':		'Nintendo DS',
			'3DS':		'Nintendo 3DS',
			'VC': 		'Virtual Console',
			'PS1':		'Sony PlayStation 1',
			'PS2':		'Sony PlayStation 2',
			'PS3':		'Sony PlayStation 3',
			'PS4':		'Sony PlayStation 4',
			'PS5':		'Sony PlayStation 5',
			'PSP':		'Sony PlayStation Portable',
			'PSTV':		'Sony PlayStation TV',
			'XbC':		'Microsoft Xbox (the first one)',
			'Xb360':	'Microsoft Xbox 360 (the second one)',
			'Xb1':		'Microsoft Xbox One (the third one)',
			'XSX':		'Microsoft Xbox Series X (the fourth and newest one)',
			'PCE':		'NEC PC Engine/TurboGrafx-16',
			'TG16':		'NEC TurboGrafx-16/PC Engine',
		};
		return platforms.hasOwnProperty(w) ? '<abbr title="' + platforms[w] + '">' + w + '</abbr>' : w;
	}).join(' ');
}
function simplifyRatingString(input){
	const ratings = {
		'N/R':   'N',
		'☆☆☆☆☆': '0',
		'★☆☆☆☆': '1',
		'★★☆☆☆': '2',
		'★★★☆☆': '3',
		'★★★★☆': '4',
		'★★★★★': '5',
		'★☆★☆★': 'S',
		'☆★☆★☆': 'S',
	};
	
	return ratings[input] ?? 'N';
}

function loadReviewsForMarathon(event, reset = true){
	fetch(`${event}.txt`, { cache: 'reload' })
	.then(response => response.text())
	.then(loadReviews);
}

function loadReviews(input){
	
	var run_container = document.getElementById("runs");
	var navbar_container = document.getElementById("days");
	
	// clear out runs table and daily navbar
	run_container.replaceChildren();
	navbar_container.replaceChildren();
	
	for (run of input.trim().split("\n\n")){
		var lines = run.split("\n");
		
		if (lines.length == 3 && lines[0].startsWith('===')){
			// looks like a starter header
			var name = lines[0].replaceAll('=', '');
			
			var header_element = document.createElement('h1');
			header_element.innerHTML = name + "<span>" + lines[1].replaceAll('=', '') + "</span><span>" + lines[2].replaceAll('=', '') + "</span>";
			run_container.appendChild(header_element);
			
			continue;
		} else if (lines.length == 1 && lines[0].startsWith('---')){
			// looks like a section header
			var name = lines[0].replaceAll('-', '');
			
			var header_element = document.createElement('h2');
			header_element.innerHTML = header_element.id = name;
			run_container.appendChild(header_element);
			
			var link_element = document.createElement('a');
			link_element.innerHTML = name;
			link_element.href = "#" + name;
			navbar_container.appendChild(link_element);
			
			continue;
		} else if (lines.length == 1 && lines[0].startsWith('[[[')){
			// looks like a block header
			var name = lines[0].replaceAll('[', '').replaceAll(']', '');
			
			// TODO: set some kind of block flag to style runs within it? Not actually sure how I want to display these
			
			continue;
		}
		
		// for safety, ignore all other insufficiently-long runs
		if (lines.length < 10){
			console.log("Skipping entry: " + run);
			continue;
		}
		
		var run_element = document.createElement("gdq-run");
		run_element.className = document.body.className;
		
		var title_re = lines[0].match(/([^\(\)]+) \((.+) - ([^\(\)]+) ((YEAR)|[0-9,; ]+)\)/);
		var time_re = lines[4].match(/(~?[^\(\)]+) \(([A-Za-z0-9 ?]+), ([A-Za-z0-9% ,?-]+)\)([\[\] A-Z0-9?]*)/);
		var youtube_re = lines[8].match(/Youtube ([A-Za-z0-9_-]+)\+?([0-9]*)/);
		
		if (title_re == null){
			console.log("Error parsing title: " + lines[0]);
			continue;
		}
		if (time_re == null){
			console.log("Error parsing time: " + lines[4]);
			continue;
		}
		if (youtube_re == null){
			console.log("Error parsing video link: " + lines[4]);
			continue;
		}
		
		run_element.appendChild(createSlot("game", title_re[1]));
		run_element.appendChild(createSlot("plat", definePlatforms(title_re[2])));
		run_element.appendChild(createSlot("dev",  title_re[3]));
		run_element.appendChild(createSlot("year", title_re[4]));
		run_element.appendChild(createSlot("category", lines[1]));
		run_element.appendChild(createSlot("runner", defineTags(lines[2])));
		run_element.appendChild(createSlot("crew", defineTags(lines[3])));
		run_element.appendChild(createSlot("time", time_re[1]));
		run_element.appendChild(createSlot("estimate", time_re[2]));
		run_element.appendChild(createSlot("wr", time_re[3].replaceAll('igt', '<abbr title="In-Game Time">igt</abbr>')));
		run_element.appendChild(createSlot("time-tags", defineTags(time_re[4])));
		run_element.appendChild(createSlot("overall", lines[5].substring(8)));
		run_element.appendChild(createSlot("skill", lines[6].substring(8)));
		run_element.appendChild(createSlot("fun", lines[7].substring(8)));
		run_element.appendChild(createSlot("review", lines[9].substring(8)));
		
		run_element.setAttribute("yt-url", youtube_re[1]);
		run_element.setAttribute("yt-offset", youtube_re[2]);
		run_element.setAttribute("rating", simplifyRatingString(lines[5].substring(8)));
		run_element.setAttribute("game", title_re[1].toLowerCase());
		run_element.setAttribute("platform", title_re[2].toLowerCase());
		run_element.setAttribute("category", lines[1].toLowerCase());
		run_element.setAttribute("runner", lines[2].toLowerCase());
		run_element.setAttribute("crew", lines[3].toLowerCase());
		// TODO: NBs, NMs, etc?
		
		run_container.appendChild(run_element);
	}

	for (element of document.getElementsByTagName("gdq-run")){
		element.onclick = function(ev){
			if (ev.target.slot == "overall" || ev.target.slot == "skill" || ev.target.slot == "fun") {
				// clicked on a rating, pop up the ratings guide
				var key = document.getElementById("ratings-key");
				key.hidden = !key.hidden;
			} else {
				// clicked on something else, set the current video
				console.log("Setting player to " + this.getAttribute("yt-url") + " +" + this.getAttribute("yt-offset"));
				if (player.getPlayerState() == 1){
					// currently playing, start instantly
					player.loadVideoById(this.getAttribute("yt-url"), this.getAttribute("yt-offset"));
				} else {
					// currently cued/paused/buffering/stopped, just cue it up
					player.cueVideoById(this.getAttribute("yt-url"), this.getAttribute("yt-offset"));
				}
				hideAllContentBut('player');
			}
		}
	}
	
	refreshFilters();
}

function refreshFilters(){
	var allowedRatings = [];
	for (element of document.querySelectorAll("input[rating]").values()){
		if (element.checked){
			allowedRatings.push(element.attributes.rating.value);
		}
	}
	
	var allowedRunner = document.getElementsByName("runner")[0].value.toLowerCase();
	var allowedCrew = document.getElementsByName("crew")[0].value.toLowerCase();
	var allowedGame = document.getElementsByName("game")[0].value.toLowerCase();
	var allowedCategory = document.getElementsByName("category")[0].value.toLowerCase();
	var allowedPlatform = document.getElementsByName("platform")[0].value.toLowerCase();
	
	for (element of document.getElementsByTagName("gdq-run")){
		var passed = true;
		
		if (allowedRatings.length){
			passed = passed && allowedRatings.includes(element.attributes.rating.value);
		}
		if (allowedRunner){
			passed = passed && element.attributes.runner.value.includes(allowedRunner);
		}
		if (allowedCrew){
			passed = passed && element.attributes.crew.value.includes(allowedCrew);
		}
		if (allowedGame){
			passed = passed && element.attributes.game.value.includes(allowedGame);
		}
		if (allowedCategory){
			passed = passed && element.attributes.category.value.includes(allowedCategory);
		}
		if (allowedPlatform){
			passed = passed && element.attributes.platform.value.split(" ").includes(allowedPlatform);
		}
		
		element.hidden = !passed;
	}
}

for (element of document.getElementsByTagName("input")){
	element.oninput = refreshFilters;
}

customElements.define('gdq-run',
	class extends HTMLElement {
		constructor() {
			super();
			let template = document.getElementById('gdq-run');
			let templateContent = template.content;
			
			const shadowRoot = this.attachShadow({mode: 'open'}).appendChild(templateContent.cloneNode(true));
		}
	}
);

// load a Youtube player
var tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
var player;
function onYouTubeIframeAPIReady() {
	player = new YT.Player('player', {
		height: getComputedStyle(document.getElementById("player")).getPropertyValue("--player-height").replace('px', ''),
		width: getComputedStyle(document.getElementById("player")).getPropertyValue("--player-width").replace('px', ''),
		videoId: '',
		playerVars: {
			'playsinline': 1
		},
		events: {}
	});
	
	// check URL params, see if we should shortcut into a marathon
	let params = new URLSearchParams(document.location.search);
	let marathon = params.get("m");
	if (marathon != null){
		loadMarathon(marathon, false);
	} else {
		hideAllContentBut('browser');
	}
}

// check URL params, see if we should shortcut into a marathon
let params = new URLSearchParams(document.location.search);
let marathon = params.get("m");
if (marathon != null){
	loadMarathon(marathon, false);
} else {
	hideAllContentBut('browser');
}
</script>
</body>
</html>